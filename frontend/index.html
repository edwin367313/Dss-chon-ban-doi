<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DSS Mate</title>
<style>
:root{--bg:#0f1115;--card:#161a22;--text:#e7e9ee;--muted:#9aa3b2;--border:#222838;--primary:#5b7cfe;--ok:#2ecc71;--no:#ff6b6b}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:#9db1ff;text-decoration:none}
.topbar{display:flex;gap:8px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#0d1016;position:sticky;top:0;z-index:10}
.brand{font-weight:800}
.spacer{flex:1}
.btn{border:1px solid var(--border);background:#0f1320;color:#e7e9ee;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn.primary{background:var(--primary);border-color:transparent;color:#fff}
.btn.ghost{background:transparent}
.btn.ok{background:var(--ok);color:#000;border-color:transparent}
.btn.no{background:var(--no);color:#000;border-color:transparent}
.container{max-width:1180px;margin:0 auto;padding:16px}
h2{margin:16px 0 8px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
input,select,textarea{width:100%;background:#0f1320;color:#e7e9ee;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
label{font-size:.9rem;color:var(--muted)}
.tabpage{display:none}
.tabpage.active{display:block}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:980px){.grid2{grid-template-columns:1fr}}
.filters{display:grid;grid-template-columns:1fr 140px 120px 120px 1fr 120px auto;gap:8px}
@media (max-width:980px){.filters{grid-template-columns:1fr 1fr}}
.deck{position:relative;width:100%;max-width:420px;height:560px;margin:0 auto}
.cardUser{position:absolute;inset:0;background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,.25);transition:transform .25s ease,opacity .25s ease}
.cardUser img.hero{width:100%;height:60%;object-fit:cover;background:#0c0f17}
.meta{padding:12px;display:flex;gap:12px}
.avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.name{font-weight:800}
.muted{color:var(--muted)}
.actions{display:flex;justify-content:center;gap:12px;margin-top:10px}
.end{height:560px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:18px;color:var(--muted)}
.kv{display:grid;grid-template-columns:160px 1fr;gap:4px 8px;color:var(--muted);font-size:.92rem;padding:0 12px 12px}
.badge{position:absolute;top:10px;left:10px;background:#000a;padding:6px 8px;border-radius:10px;border:1px solid var(--border)}
.list{max-height:440px;overflow:auto}
.item{padding:10px;border-bottom:1px solid var(--border);cursor:pointer}
.item:hover{background:#101525}
.chat{display:grid;grid-template-columns:320px 1fr;gap:12px}
@media (max-width:980px){.chat{grid-template-columns:1fr}}
.chatPanel{height:70vh;display:flex;flex-direction:column}
.chatHead{padding:12px;border-bottom:1px solid var(--border)}
.chatBody{flex:1;overflow:auto;padding:12px}
.msg{max-width:70%;padding:10px 12px;border-radius:12px;margin:6px 0}
.me{background:#2b4cff;color:#fff;margin-left:auto}
.other{background:#1a1f2c}
.chatForm{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
.hidden{display:none}
.small{font-size:.9rem;color:var(--muted)}
hr.sep{border:0;border-top:1px solid var(--border);margin:10px 0}
.badgetxt{background:#0e1322;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">DSS Mate</div>
  <div class="row">
    <button class="btn tabbtn" data-tab="home">Trang ch·ªß</button>
    <button class="btn tabbtn" data-tab="auth">ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω</button>
    <button class="btn tabbtn" data-tab="browse">T√¨m & Qu·∫πt</button>
    <button class="btn tabbtn" data-tab="chat">Chat</button>
    <button class="btn tabbtn" data-tab="backup">Sao l∆∞u</button>
    <button class="btn tabbtn" data-tab="phongthuy">Phong thu·ª∑</button>
  </div>
  <div class="spacer"></div>
  <div id="whoami" class="small"></div>
  <button class="btn ghost" id="btnLogout">ƒêƒÉng xu·∫•t</button>
</header>

<main class="container">
  <!-- AUTH -->
  <section id="tab-auth" class="tabpage">
    <div class="grid2">
      <div class="card">
        <h2>ƒêƒÉng nh·∫≠p</h2>
        <div class="row">
          <div style="flex:1">
            <label>Ch·ªçn ng∆∞·ªùi d√πng c√≥ s·∫µn</label>
            <select id="lgSelect"></select>
          </div>
          <button class="btn primary" id="btnLoginSelect" style="height:42px;align-self:end">ƒêƒÉng nh·∫≠p</button>
        </div>
        <div style="margin-top:10px">
          <label>Email</label>
          <input id="lgEmail" placeholder="email (t√πy ch·ªçn)">
          <button class="btn" id="btnLoginEmail" style="margin-top:8px">ƒêƒÉng nh·∫≠p theo email</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnLoginNam">ƒêƒÉng nh·∫≠p: Test Nam</button>
          <button class="btn" id="btnLoginNu">ƒêƒÉng nh·∫≠p: Test Nu</button>
        </div>
      </div>

      <div class="card">
        <h2>ƒêƒÉng k√Ω (t·∫°o ng∆∞·ªùi m·ªõi)</h2>
        <div class="row">
          <div style="flex:1">
            <label>H·ªç t√™n</label>
            <input id="rgName" placeholder="VD: Nguyen Van A">
          </div>
          <div style="width:160px">
            <label>Gi·ªõi t√≠nh</label>
            <select id="rgGender"><option>Nam</option><option>N·ªØ</option><option>Kh√°c</option></select>
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>NƒÉm sinh</label>
            <input id="rgYear" type="number" placeholder="1998">
          </div>
          <div style="flex:1">
            <label>Ngh·ªÅ nghi·ªáp</label>
            <input id="rgJob" placeholder="Developer">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>ƒê·ªãa ch·ªâ</label>
            <input id="rgAddress" placeholder="Ha Noi / Quan...">
          </div>
          <div style="flex:1">
            <label>T√†i ch√≠nh (tri·ªáu/th√°ng)</label>
            <input id="rgFinance" type="number" placeholder="20">
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>Email</label>
            <input id="rgEmail" placeholder="abc@example.com">
          </div>
          <div style="flex:1">
            <label>ƒêi·ªán tho·∫°i</label>
            <input id="rgPhone" placeholder="09...">
          </div>
        </div>
        <div>
          <label>Gi·ªõi thi·ªáu</label>
          <textarea id="rgBio" rows="2" placeholder="M√¥ t·∫£ ng·∫Øn..."></textarea>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>S·ªü th√≠ch</label>
            <textarea id="rgHobbies" rows="2"></textarea>
          </div>
          <div style="flex:1">
            <label>Th√≥i quen</label>
            <textarea id="rgHabits" rows="2"></textarea>
          </div>
        </div>
        <div style="margin-top:6px">
          <label>Gi√° tr·ªã s·ªëng</label>
          <textarea id="rgValues" rows="2"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>·∫¢nh ƒë·∫°i di·ªán</label>
            <input id="rgAvatar" type="file" accept="image/*">
          </div>
          <img id="rgPreview" class="avatar" style="width:72px;height:72px;border-radius:10px" src="" alt="">
          <div class="spacer"></div>
          <button class="btn primary" id="btnCreate">T·∫°o t√†i kho·∫£n</button>
        </div>
        <hr class="sep">
        <h3>Ng∆∞·ªùi d√πng g·∫ßn ƒë√¢y</h3>
        <div id="userList" class="list"></div>
      </div>
    </div>
  </section>

  <!-- BROWSE & SWIPE -->
  <section id="tab-browse" class="tabpage">
    <div class="card">
      <h2>B·ªô l·ªçc</h2>
      <div class="filters">
        <input id="fltQ" placeholder="T√™n / c√¥ng vi·ªác / bio...">
        <select id="fltGender"><option value="">Gi·ªõi t√≠nh</option><option>Nam</option><option>N·ªØ</option><option>Kh√°c</option></select>
        <input id="fltAgeMin" type="number" placeholder="Tu·ªïi t·ª´">
        <input id="fltAgeMax" type="number" placeholder="Tu·ªïi ƒë·∫øn">
        <input id="fltJob" placeholder="Ngh·ªÅ nghi·ªáp">
        <input id="fltFinanceMax" type="number" placeholder="T·ªëi ƒëa (tri·ªáu)">
        <div class="row">
          <button class="btn" id="btnReset">Reset</button>
          <button class="btn primary" id="btnFilter">L·ªçc</button>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <h2>Deck qu·∫πt</h2>
        <div id="deck" class="deck"></div>
        <div class="actions">
          <button class="btn no" id="btnSkip">üëé B·ªè qua</button>
          <button class="btn ok" id="btnLike">üëç Th√≠ch</button>
        </div>
        <div class="small" style="text-align:center;margin-top:6px">
          M·∫πo: ph√≠m ‚Üê / ‚Üí ƒë·ªÉ b·ªè qua / th√≠ch
        </div>
      </div>
      <div class="card">
        <h2>Gi·∫£i th√≠ch</h2>
        <div id="explainBox" class="kv"></div>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section id="tab-chat" class="tabpage">
    <div class="chat">
      <div class="card chatPanel">
        <div class="chatHead">Danh s√°ch match</div>
        <div id="matchList" class="list"></div>
      </div>
      <div class="card chatPanel">
        <div id="chatHeader" class="chatHead">Ch·ªçn 1 match ƒë·ªÉ chat</div>
        <div id="chatBody" class="chatBody"></div>
        <form id="chatForm" class="chatForm hidden">
          <input id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
          <button class="btn primary" type="submit">G·ª≠i</button>
        </form>
      </div>
    </div>
  </section>


  <!-- PHONG THUY TABLES -->
  <section id="tab-phongthuy" class="tabpage">
    <div class="card">
      <h2>B·∫£ng tham chi·∫øu phong thu·ª∑</h2>
      <div class="row">
        <div style="flex:1">
          <h3>N·∫°p √¢m (can+chi ‚Üí n·∫°p √¢m)</h3>
          <div id="tblNapAm" class="small"></div>
        </div>
        <div style="flex:1">
          <h3>Cung phi (nam/n·ªØ) & B√°t tr·∫°ch</h3>
          <div id="tblCungPhi" class="small"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/* ====== SEED DEMO (10 user) ====
*/
const DATA_SEED = [
  {name:"Lan", gender:"N·ªØ", year:1997, job:"Designer", address:"HN", bio:"Yeu tranh", avatar:"", finance:20},
  {name:"Minh", gender:"Nam", year:1993, job:"Dev", address:"HN", bio:"Thich code", avatar:"", finance:35},
  {name:"Thao", gender:"N·ªØ", year:1996, job:"Y ta", address:"HP", bio:"Cham chi", avatar:"", finance:18},
  {name:"Duc", gender:"Nam", year:1990, job:"Marketing", address:"HCM", bio:"Nang dong", avatar:"", finance:30},
  {name:"Huong", gender:"N·ªØ", year:1998, job:"Ke toan", address:"DN", bio:"Can than", avatar:"", finance:16},
  {name:"Phong", gender:"Nam", year:1995, job:"Data", address:"HCM", bio:"Phan tich", avatar:"", finance:40},
  {name:"Ha", gender:"N·ªØ", year:1999, job:"Sinh vien", address:"HN", bio:"Nang dong", avatar:"", finance:8},
  {name:"Tuan", gender:"Nam", year:1994, job:"QA", address:"HN", bio:"Ki luong", avatar:"", finance:22},
  {name:"My", gender:"N·ªØ", year:1995, job:"BA", address:"HCM", bio:"Giao tiep tot", avatar:"", finance:25},
  {name:"Hieu", gender:"Nam", year:1992, job:"Tester", address:"DN", bio:"Tinh te", avatar:"", finance:28}
];

/* ===== IndexedDB Wrapper ===== */
const IDB = (()=> {
  const DB_NAME='DSSMateDB'; const DB_VERSION=3;
  const STORES={ users:{keyPath:'id'}, swipes:{keyPath:'id'}, matches:{keyPath:'id'}, messages:{keyPath:'id'}, meta:{keyPath:'key'} };
  let _dbp=null;
  function open(){ if(_dbp) return _dbp; _dbp=new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VERSION);
    req.onupgradeneeded=ev=>{ const db=ev.target.result;
      Object.entries(STORES).forEach(([n,opt])=>{ if(!db.objectStoreNames.contains(n)) db.createObjectStore(n,opt); });
    };
    req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error);
  }); return _dbp;}
  function tx(store,mode='readonly'){ return open().then(db=>db.transaction(store,mode).objectStore(store)); }
  async function getAll(store){ const os=await tx(store); return new Promise((res,rej)=>{ const r=os.getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); }); }
  async function get(store,key){ const os=await tx(store); return new Promise((res,rej)=>{ const r=os.get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }); }
  async function put(store,obj){ const os=await tx(store,'readwrite'); return new Promise((res,rej)=>{ const r=os.put(obj); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }
  async function bulkPut(store,arr){ const db=await open(); return new Promise((res,rej)=>{ const t=db.transaction(store,'readwrite'); const os=t.objectStore(store); arr.forEach(o=>os.put(o)); t.oncomplete=()=>res(true); t.onerror=()=>rej(t.error); }); }
  async function clear(store){ const os=await tx(store,'readwrite'); return new Promise((res,rej)=>{ const r=os.clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }
  return {open,getAll,get,put,bulkPut,clear};
})();

const Session={
  async get(){return await IDB.get('meta','whoami');},
  async set(userId){return await IDB.put('meta',{key:'whoami',userId});},
  async clear(){const db=await IDB.open(); return new Promise((res,rej)=>{ const t=db.transaction('meta','readwrite'); t.objectStore('meta').delete('whoami'); t.oncomplete=()=>res(true); t.onerror=()=>rej(t.error); });}
};

/* ===== Phong thuy core ===== */
const THIEN_CAN=["Gi√°p","·∫§t","B√≠nh","ƒêinh","M·∫≠u","K·ª∑","Canh","T√¢n","Nh√¢m","Qu√Ω"];
const DIA_CHI=["T√Ω","S·ª≠u","D·∫ßn","M√£o","Th√¨n","T·ªµ","Ng·ªç","M√πi","Th√¢n","D·∫≠u","Tu·∫•t","H·ª£i"];
const NAP_AM_60=[
 "H·∫£i Trung Kim","H·∫£i Trung Kim","L∆∞ Trung H·ªèa","L∆∞ Trung H·ªèa","ƒê·∫°i L√¢m M·ªôc","ƒê·∫°i L√¢m M·ªôc","L·ªô B√†ng Th·ªï","L·ªô B√†ng Th·ªï","Ki·∫øm Phong Kim","Ki·∫øm Phong Kim",
 "S∆°n ƒê·∫ßu H·ªèa","S∆°n ƒê·∫ßu H·ªèa","Gi·∫£n H·∫° Th·ªßy","Gi·∫£n H·∫° Th·ªßy","Th√†nh ƒê·∫ßu Th·ªï","Th√†nh ƒê·∫ßu Th·ªï","B·∫°ch L·∫°p Kim","B·∫°ch L·∫°p Kim","D∆∞∆°ng Li·ªÖu M·ªôc","D∆∞∆°ng Li·ªÖu M·ªôc",
 "Tuy·ªÅn Trung Th·ªßy","Tuy·ªÅn Trung Th·ªßy","·ªêc Th∆∞·ª£ng Th·ªï","·ªêc Th∆∞·ª£ng Th·ªï","T√≠ch L·ªãch H·ªèa","T√≠ch L·ªãch H·ªèa","T√πng B√°ch M·ªôc","T√πng B√°ch M·ªôc","Tr∆∞·ªùng L∆∞u Th·ªßy","Tr∆∞·ªùng L∆∞u Th·ªßy",
 "Sa Trung Kim","Sa Trung Kim","S∆°n H·∫° H·ªèa","S∆°n H·∫° H·ªèa","B√¨nh ƒê·ªãa M·ªôc","B√¨nh ƒê·ªãa M·ªôc","B√≠ch Th∆∞·ª£ng Th·ªï","B√≠ch Th∆∞·ª£ng Th·ªï","Kim B·∫°ch Kim","Kim B·∫°ch Kim",
 "Ph√∫c ƒêƒÉng H·ªèa","Ph√∫c ƒêƒÉng H·ªèa","Thi√™n H√† Th·ªßy","Thi√™n H√† Th·ªßy","ƒê·∫°i Tr·∫°ch Th·ªï","ƒê·∫°i Tr·∫°ch Th·ªï","Thoa Xuy·∫øn Kim","Thoa Xuy·∫øn Kim","Tang ƒê·ªë M·ªôc","Tang ƒê·ªë M·ªôc",
 "ƒê·∫°i Kh√™ Th·ªßy","ƒê·∫°i Kh√™ Th·ªßy","Sa Trung Th·ªï","Sa Trung Th·ªï","Thi√™n Th∆∞·ª£ng H·ªèa","Thi√™n Th∆∞·ª£ng H·ªèa","Th·∫°ch L·ª±u M·ªôc","Th·∫°ch L·ª±u M·ªôc","ƒê·∫°i H·∫£i Th·ªßy","ƒê·∫°i H·∫£i Th·ªßy"
];
const NAP_AM_TO_ELEMENT={
 "H·∫£i Trung Kim":"Kim","Ki·∫øm Phong Kim":"Kim","Sa Trung Kim":"Kim","Kim B·∫°ch Kim":"Kim","Thoa Xuy·∫øn Kim":"Kim","B·∫°ch L·∫°p Kim":"Kim",
 "L∆∞ Trung H·ªèa":"H·ªèa","S∆°n ƒê·∫ßu H·ªèa":"H·ªèa","T√≠ch L·ªãch H·ªèa":"H·ªèa","S∆°n H·∫° H·ªèa":"H·ªèa","Ph√∫c ƒêƒÉng H·ªèa":"H·ªèa","Thi√™n Th∆∞·ª£ng H·ªèa":"H·ªèa",
 "ƒê·∫°i L√¢m M·ªôc":"M·ªôc","D∆∞∆°ng Li·ªÖu M·ªôc":"M·ªôc","T√πng B√°ch M·ªôc":"M·ªôc","B√¨nh ƒê·ªãa M·ªôc":"M·ªôc","Tang ƒê·ªë M·ªôc":"M·ªôc","Th·∫°ch L·ª±u M·ªôc":"M·ªôc",
 "L·ªô B√†ng Th·ªï":"Th·ªï","Th√†nh ƒê·∫ßu Th·ªï":"Th·ªï","·ªêc Th∆∞·ª£ng Th·ªï":"Th·ªï","B√≠ch Th∆∞·ª£ng Th·ªï":"Th·ªï","Sa Trung Th·ªï":"Th·ªï","ƒê·∫°i Tr·∫°ch Th·ªï":"Th·ªï",
 "Gi·∫£n H·∫° Th·ªßy":"Th·ªßy","Tuy·ªÅn Trung Th·ªßy":"Th·ªßy","Tr∆∞·ªùng L∆∞u Th·ªßy":"Th·ªßy","Thi√™n H√† Th·ªßy":"Th·ªßy","ƒê·∫°i Kh√™ Th·ªßy":"Th·ªßy","ƒê·∫°i H·∫£i Th·ªßy":"Th·ªßy"
};
const ELEMENT_REL={
  "M·ªôc->H·ªèa":"Sinh","H·ªèa->Th·ªï":"Sinh","Th·ªï->Kim":"Sinh","Kim->Th·ªßy":"Sinh","Th·ªßy->M·ªôc":"Sinh"
};
const EAST_GROUP=new Set(["Kh·∫£m","Ly","Ch·∫•n","T·ªën"]);
const WEST_GROUP=new Set(["C√†n","ƒêo√†i","C·∫•n","Kh√¥n"]);

function digitSum(n){let s=0;while(n>0){s+=n%10;n=Math.floor(n/10);}return s>9?digitSum(s):s;}
function cungPhi(year, gender){
  const base=digitSum(year); let num;
  if(gender==="Nam"){ num=10-base; if(year>=2000) num+=1; if(num<=0) num=digitSum(-num); if(num===5) num=2; }
  else { num=5+base; if(year>=2000) num+=1; if(num>9) num=digitSum(num); if(num===5) num=8; }
  const map={1:"Kh·∫£m",2:"Kh√¥n",3:"Ch·∫•n",4:"T·ªën",6:"C√†n",7:"ƒêo√†i",8:"C·∫•n",9:"Ly"};
  return map[num]||"Kh√¥n";
}
function batTrachScore(c1,c2){
  if(!c1||!c2) return {type:"Kh√¥ng r√µ",score:0};
  const g1=EAST_GROUP.has(c1)?"ƒê√¥ng":"T√¢y";
  const g2=EAST_GROUP.has(c2)?"ƒê√¥ng":"T√¢y";
  if(g1===g2){
    if(c1===c2) return {type:"Ph·ª•c V·ªã", score:1};
    return {type:"Sinh Kh√≠/Thi√™n Y (c√πng nh√≥m)", score:2};
  } else {
    return {type:"Ng≈© Qu·ª∑/L·ª•c S√°t/Tuy·ªát M·ªánh (kh√°c nh√≥m)", score:-2};
  }
}
function infoFromYear(y){
  const idx60=(y-4)%60;
  const can=THIEN_CAN[(y+6)%10];
  const chi=DIA_CHI[(y+8)%12];
  const napAm=NAP_AM_60[idx60];
  const element=NAP_AM_TO_ELEMENT[napAm];
  return {can,chi,napAm,element};
}
function phongThuyRelation(u1,u2){
  const e1=u1.element,e2=u2.element;
  let nh={type:'?',score:0};
  if(e1&&e2){
    if(e1===e2) nh={type:"ƒê·ªìng h√†nh",score:1};
    else if(ELEMENT_REL[`${e1}->${e2}`]) nh={type:"Sinh",score:2};
    else if(ELEMENT_REL[`${e2}->${e1}`]) nh={type:"ƒê∆∞·ª£c sinh",score:1};
    else nh={type:"Kh·∫Øc",score:-2};
  }
  let nap={type:u1.napAm+" / "+u2.napAm,score:0};
  if(u1.element===u2.element) nap.score=1;
  const bt=batTrachScore(u1.cungPhi,u2.cungPhi);
  const total=nh.score+nap.score+bt.score;
  let verdict = "Kh√¥ng h·ª£p";
  if(total>=3) verdict="R·∫•t h·ª£p";
  else if(total>=1) verdict="H∆°i h·ª£p";
  else if(total>=0) verdict="C√¢n nh·∫Øc";
  return { nguHanh:nh, napAm:nap, batTrach:bt, total, verdict };
}

/* ===== Helpers ===== */
const qs=(s,el=document)=>el.querySelector(s);
const whoamiEl=qs('#whoami');
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
function uid(prefix='u'){return prefix+'_'+Math.random().toString(36).slice(2,10);}
function yNow(){return (new Date()).getFullYear();}
async function currentUser(){ const sess=await Session.get(); if(!sess?.userId) return null; const users=await IDB.getAll('users'); return users.find(u=>u.id===sess.userId)||null; }
function updateWhoami(u){ whoamiEl.textContent = u?`ƒêang l√†: ${u.name} (${u.element||'‚Äî'} / ${u.cungPhi||'‚Äî'})`:'Ch∆∞a ƒëƒÉng nh·∫≠p'; }

/* ===== Tab switching ===== */
document.querySelectorAll('.tabbtn').forEach(b=>{
  b.onclick=async()=>{
    document.querySelectorAll('.tabpage').forEach(p=>p.classList.remove('active'));
    qs('#tab-'+b.dataset.tab).classList.add('active');
    if(b.dataset.tab==='auth'){await renderLoginSelect(); await renderUserList();}
    if(b.dataset.tab==='browse'){await bootBrowse();}
    if(b.dataset.tab==='chat'){await bootChat();}
    if(b.dataset.tab==='phongthuy'){renderPhongThuyTables();}
  };
});
qs('#btnLogout').onclick=async()=>{await Session.clear(); updateWhoami(null); alert('ƒê√£ ƒëƒÉng xu·∫•t');};

/* ===== Auth ===== */
const lgSelect=qs('#lgSelect');
async function renderLoginSelect(){
  const users=await IDB.getAll('users');
  lgSelect.innerHTML=users.map(u=>`<option value="${u.id}">${u.name} ‚Ä¢ ${yNow()-u.year}t ‚Ä¢ ${u.element||'‚Äî'} (${u.cungPhi||'‚Äî'})</option>`).join('');
}
qs('#btnLoginSelect').onclick=async()=>{
  const id=lgSelect.value; if(!id) return alert('Ch·ªçn ng∆∞·ªùi d√πng');
  await Session.set(id); updateWhoami(await currentUser()); alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
};
qs('#btnLoginEmail').onclick=async()=>{
  const email=qs('#lgEmail').value.trim(); if(!email) return alert('Nh·∫≠p email');
  const us=await IDB.getAll('users');
  const u=us.find(x=>(x.email||'').toLowerCase()===email.toLowerCase());
  if(!u) return alert('Kh√¥ng t√¨m th·∫•y email');
  await Session.set(u.id); updateWhoami(u); alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
};
qs('#btnLoginNam').onclick=async()=>{
  const us=await IDB.getAll('users'); const u=us.find(x=>x.name==='Test Nam');
  if(!u) return alert('Ch∆∞a seed'); await Session.set(u.id); updateWhoami(u); alert('ƒêƒÉng nh·∫≠p: Test Nam');
};
qs('#btnLoginNu').onclick=async()=>{
  const us=await IDB.getAll('users'); const u=us.find(x=>x.name==='Test Nu');
  if(!u) return alert('Ch∆∞a seed'); await Session.set(u.id); updateWhoami(u); alert('ƒêƒÉng nh·∫≠p: Test Nu');
};

const rg={ name:rgName, gender:rgGender, year:rgYear, job:rgJob, addr:rgAddress, finance:rgFinance, email:rgEmail, phone:rgPhone, bio:rgBio, hobbies:rgHobbies, habits:rgHabits, values:rgValues, avatar:rgAvatar, preview:rgPreview };
rg.avatar.onchange=async e=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>rg.preview.src=r.result; r.readAsDataURL(f);};
qs('#btnCreate').onclick=async()=>{
  const name=rg.name.value.trim(); const year=parseInt(rg.year.value);
  if(!name||!year) return alert('Nh·∫≠p t√™n v√† nƒÉm sinh');
  let avatar=''; if(rg.avatar.files?.[0]){ const fr=new FileReader(); avatar=await new Promise((res,rej)=>{fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(rg.avatar.files[0]);}); }
  const id=uid('u'); const {can,chi,napAm,element}=infoFromYear(year); const cp=cungPhi(year, rg.gender.value);
  const u={ id, name, gender:rg.gender.value, year, job:rg.job.value.trim(), finance:parseInt(rg.finance.value)||null, address:rg.addr.value.trim(), email:(rg.email.value.trim()||null), phone:(rg.phone.value.trim()||null), bio:rg.bio.value.trim(), hobbies:rg.hobbies.value.trim(), habits:rg.habits.value.trim(), values:rg.values.value.trim(), avatar, can, chi, napAm, element, cungPhi:cp, createdAt: Date.now() };
  await IDB.put('users',u); await Session.set(id); updateWhoami(u); await renderLoginSelect(); await renderUserList(); alert('ƒê√£ t·∫°o t√†i kho·∫£n & ƒëƒÉng nh·∫≠p: '+name);
  ['name','year','job','addr','finance','email','phone','bio','hobbies','habits','values'].forEach(k=> rg[k].value=''); rg.avatar.value=''; rg.preview.src='';
};
async function renderUserList(){
  const users=(await IDB.getAll('users')).sort((a,b)=>b.createdAt-a.createdAt);
  qs('#userList').innerHTML=users.map(u=>{
    const age=yNow()-u.year;
    return `<div class="item"><b>${u.name}</b> ‚Ä¢ ${u.gender}, ${age}t ‚Ä¢ ${u.job||'‚Äî'} ‚Ä¢ ${u.element||'‚Äî'} (${u.can} ${u.chi}) ‚Äî ${u.cungPhi||'‚Äî'}</div>`;
  }).join('');
}

/* ===== Browse & Swipe ===== */
const deckEl=qs('#deck'); const explainEl=qs('#explainBox'); let browse={me:null,list:[],idx:0};
function userCard(u){
  const age=yNow()-u.year;
  const cover=u.avatar||'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nNDgwJyBoZWlnaHQ9JzMyMCcgZmlsbD0nI0FBQScgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJz48L3N2Zz4=';
  return `<div class="cardUser">
    <span class="badge">${u.element||'‚Äî'} ‚Ä¢ ${u.can} ${u.chi}</span>
    <img class="hero" src="${cover}">
    <div class="meta">
      <img class="avatar" src="${u.avatar||cover}">
      <div style="flex:1">
        <div class="name">${u.name} ‚Ä¢ ${age}t</div>
        <div class="muted">${u.job||'‚Äî'} ‚Ä¢ ${u.address||'‚Äî'}</div>
        <div class="muted">T√†i ch√≠nh: ${u.finance?u.finance+'tr/th√°ng':'‚Äî'}</div>
      </div>
    </div>
  </div>`;
}
function renderDeck(){
  deckEl.innerHTML='';
  if(browse.idx>=browse.list.length){ deckEl.innerHTML=`<div class="end">H·∫øt g·ª£i √Ω ‚Äî h√£y ƒëi·ªÅu ch·ªânh b·ªô l·ªçc</div>`; explainEl.innerHTML=''; return; }
  const stack=browse.list.slice(browse.idx).reverse(); stack.forEach(u=> deckEl.insertAdjacentHTML('beforeend', userCard(u)));
  const top=browse.list[browse.idx];
  if(browse.me&&top){
    const rel=phongThuyRelation(browse.me,top);
    const groupMe=(EAST_GROUP.has(browse.me.cungPhi)?"ƒê√¥ng":"T√¢y");
    const groupOt=(EAST_GROUP.has(top.cungPhi)?"ƒê√¥ng":"T√¢y");
    explainEl.innerHTML=`
      <div>Ng∆∞·ªùi xem: <b>${browse.me.name}</b> ‚Äî ${browse.me.element} ‚Ä¢ ${browse.me.can} ${browse.me.chi} ‚Ä¢ Cung ${browse.me.cungPhi} (${groupMe})</div>
      <div>·ª®ng vi√™n: <b>${top.name}</b> ‚Äî ${top.element} ‚Ä¢ ${top.can} ${top.chi} ‚Ä¢ Cung ${top.cungPhi} (${groupOt})</div>
      <div>Ng≈© h√†nh: <b>${rel.nguHanh.type}</b> (ƒëi·ªÉm ${rel.nguHanh.score>=0?'+':''}${rel.nguHanh.score})</div>
      <div>N·∫°p √¢m: <b>${rel.napAm.type}</b> (ƒëi·ªÉm ${rel.napAm.score>=0?'+':''}${rel.napAm.score})</div>
      <div>B√°t tr·∫°ch: <b>${rel.batTrach.type}</b> (ƒëi·ªÉm ${rel.batTrach.score>=0?'+':''}${rel.batTrach.score})</div>
      <div><b>T·ªïng:</b> ${rel.total>=0?'+':''}${rel.total} ‚Äî <b>${rel.verdict}</b></div>
      <div class="small">Nh·∫≠n x√©t: ${rel.total>=3?'R·∫•t thu·∫≠n l·ª£i v·ªÅ m·ªánh v√† nh√≥m cung phi. ∆Øu ti√™n l√†m quen.':(rel.total>=1?'C√≥ nhi·ªÅu ƒëi·ªÉm t∆∞∆°ng h·ª£p, c√≥ th·ªÉ ti·∫øn tri·ªÉn.':'C·∫ßn c√¢n nh·∫Øc th√™m y·∫øu t·ªë t√≠nh c√°ch, s·ªü th√≠ch.')}</div>
    `;
  } else {
    explainEl.innerHTML=`<div>Ch∆∞a ƒëƒÉng nh·∫≠p. V√†o tab ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω ƒë·ªÉ ch·ªçn ng∆∞·ªùi d√πng.</div>`;
  }
}
function currentCandidate(){return browse.list[browse.idx]||null;}
async function swipe(dir){
  const cand=currentCandidate(); if(!cand) return;
  const topCard=deckEl.querySelector('.cardUser:last-child');
  if(topCard){ topCard.style.transform=`translateX(${dir>0?120:-120}px) rotate(${dir>0?8:-8}deg)`; topCard.style.opacity='0'; setTimeout(()=>topCard.remove(),220); }
  const me=browse.me; if(!me){ browse.idx++; renderDeck(); return; }
  await IDB.put('swipes',{id:uid('s'),from:me.id,to:cand.id,dir,at:Date.now()});
  // ch·ªâ match n·∫øu kh√°c gi·ªõi t√≠nh
  if(dir>0 && me.gender!=='Kh√°c' && cand.gender!=='Kh√°c' && me.gender!==cand.gender){
    const all=await IDB.getAll('swipes');
    const otherLiked=all.find(s=>s.from===cand.id&&s.to===me.id&&s.dir>0);
    if(otherLiked){
      const ms=await IDB.getAll('matches');
      let match=ms.find(m=>(m.a===me.id&&m.b===cand.id)||(m.a===cand.id&&m.b===me.id));
      if(!match){ match={id:uid('m'),a:me.id,b:cand.id,at:Date.now()}; await IDB.put('matches',match); }
      localStorage.setItem('chat.openMatchId',match.id);
      openTab('chat'); await bootChat(); return;
    }
  }
  browse.idx++; renderDeck();
}
qs('#btnLike').onclick=()=>swipe(1);
qs('#btnSkip').onclick=()=>swipe(-1);
window.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') swipe(1); if(e.key==='ArrowLeft') swipe(-1); });

function openTab(key){ document.querySelectorAll('.tabpage').forEach(p=>p.classList.remove('active')); qs('#tab-'+key).classList.add('active'); }
async function bootBrowse(){
  const me=await currentUser(); browse.me=me;
  const f={
    q:qs('#fltQ').value.trim().toLowerCase(),
    gender:qs('#fltGender').value||'',
    ageMin:parseInt(qs('#fltAgeMin').value)||null,
    ageMax:parseInt(qs('#fltAgeMax').value)||null,
    job:qs('#fltJob').value.trim().toLowerCase(),
    financeMax:parseInt(qs('#fltFinanceMax').value)||null
  };
  const users=await IDB.getAll('users'); const yearNow=yNow();
  let pool=users.filter(u=>!me||u.id!==me.id);
  if(f.q) pool=pool.filter(u=>(u.name+' '+(u.job||'')+' '+(u.bio||'')).toLowerCase().includes(f.q));
  if(f.gender) pool=pool.filter(u=>u.gender===f.gender);
  if(f.ageMin) pool=pool.filter(u=>yearNow-u.year>=f.ageMin);
  if(f.ageMax) pool=pool.filter(u=>yearNow-u.year<=f.ageMax);
  if(f.job)    pool=pool.filter(u=>(u.job||'').toLowerCase().includes(f.job));
  if(f.financeMax!=null) pool=pool.filter(u=>(u.finance||999)<=f.financeMax);
  if(me) pool.sort((a,b)=> phongThuyRelation(me,b).total - phongThuyRelation(me,a).total);
  browse.list=pool; browse.idx=0; renderDeck();
}
qs('#btnFilter').onclick=bootBrowse;
qs('#btnReset').onclick=()=>{['fltQ','fltGender','fltAgeMin','fltAgeMax','fltJob','fltFinanceMax'].forEach(id=>{const el=qs('#'+id); if(el) el.value='';}); bootBrowse();};

/* ===== Chat ===== */
const chatEls={ list:qs('#matchList'), head:qs('#chatHeader'), body:qs('#chatBody'), form:qs('#chatForm'), input:qs('#chatInput') };
let currentChat={ matchId:null, me:null, other:null };
async function bootChat(){
  const me=await currentUser();
  const ms=(await IDB.getAll('matches')).filter(m=>m.a===me?.id||m.b===me?.id).sort((a,b)=>b.at-a.at);
  const us=await IDB.getAll('users');
  const html = ms.map(m=>{
    const otherId=(m.a===me?.id)?m.b:m.a; const other=us.find(x=>x.id===otherId);
    if(!other) return '';
    // ch·ªâ hi·ªÉn th·ªã kh√°c gi·ªõi trong b·∫£n test
    if(me&&other&&me.gender!=='Kh√°c'&&other.gender!=='Kh√°c'&&me.gender===other.gender) return '';
    return `<div class="item" data-mid="${m.id}">üí¨ ${escapeHtml(other?other.name:otherId)}</div>`;
  }).join('');
  chatEls.list.innerHTML=html;
  chatEls.list.querySelectorAll('.item').forEach(it=> it.onclick=()=>openChat(it.dataset.mid));
  const auto=localStorage.getItem('chat.openMatchId'); if(auto){ localStorage.removeItem('chat.openMatchId'); await openChat(auto); }
}
async function openChat(matchId){
  const me=await currentUser(); if(!me) return alert('H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
  const m=(await IDB.getAll('matches')).find(x=>x.id===matchId); if(!m) return;
  const otherId=(m.a===me.id)?m.b:m.a; const us=await IDB.getAll('users'); const other=us.find(x=>x.id===otherId);
  if(me.gender!=='Kh√°c'&&other?.gender!=='Kh√°c'&&me.gender===other.gender){ return alert('Chat ch·ªâ gi·ªØa Nam v√† N·ªØ trong b·∫£n test.'); }
  currentChat={ matchId, me, other }; chatEls.head.textContent=`Chat v·ªõi ${other?other.name:otherId}`; await renderMessages(); chatEls.form.classList.remove('hidden');
}
async function renderMessages(){
  const msgs=(await IDB.getAll('messages')).filter(x=>x.matchId===currentChat.matchId).sort((a,b)=>a.at-b.at);
  chatEls.body.innerHTML=msgs.map(ms=>`<div class="msg ${ms.from===currentChat.me.id?'me':'other'}">${escapeHtml(ms.body)}</div>`).join('');
  chatEls.body.scrollTop=chatEls.body.scrollHeight;
}
chatEls.form.addEventListener('submit', async e=>{
  e.preventDefault();
  const txt=chatEls.input.value.trim(); if(!txt) return;
  await IDB.put('messages',{id:uid('msg'),matchId:currentChat.matchId,from:currentChat.me.id,body:txt,at:Date.now()});
  chatEls.input.value=''; await renderMessages();
});

/* ===== Backup ===== */
qs('#btnExport').onclick=async()=>{
  const data={ users:await IDB.getAll('users'), swipes:await IDB.getAll('swipes'), matches:await IDB.getAll('matches'), messages:await IDB.getAll('messages') };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dss_offline_backup.json'; a.click();
};
qs('#btnImport').onclick=async()=>{
  const f=qs('#impFile').files?.[0]; if(!f) return alert('Ch·ªçn file JSON');
  const data=JSON.parse(await f.text());
  if(!data.users||!data.matches||!data.swipes||!data.messages) return alert('Sai ƒë·ªãnh d·∫°ng');
  await IDB.clear('users'); await IDB.bulkPut('users',data.users);
  await IDB.clear('swipes'); await IDB.bulkPut('swipes',data.swipes);
  await IDB.clear('matches'); await IDB.bulkPut('matches',data.matches);
  await IDB.clear('messages'); await IDB.bulkPut('messages',data.messages);
  await renderLoginSelect(); await renderUserList(); await bootBrowse(); await bootChat(); alert('ƒê√£ nh·∫≠p d·ªØ li·ªáu');
};

/* ===== Tables: phong thuy ===== */
function renderPhongThuyTables(){
  const rows=[]; for(let i=0;i<60;i++){ const can=THIEN_CAN[i%10], chi=DIA_CHI[i%12], na=NAP_AM_60[i]; const el=NAP_AM_TO_ELEMENT[na]; rows.push(`${(i+1).toString().padStart(2,'0')}. ${can} ${chi} ‚Üí ${na} (${el})`); }
  qs('#tblNapAm').innerHTML='<pre style="white-space:pre-wrap;line-height:1.4">'+rows.join('\n')+'</pre>';
  qs('#tblCungPhi').innerHTML=`
    <ul>
      <li>ƒê√¥ng t·ª© m·ªánh: <b>Kh·∫£m, Ly, Ch·∫•n, T·ªën</b></li>
      <li>T√¢y t·ª© m·ªánh: <b>C√†n, ƒêo√†i, C·∫•n, Kh√¥n</b></li>
      <li>C√πng nh√≥m: <i>Sinh Kh√≠/Thi√™n Y/Ph·ª•c V·ªã</i> (t·ªët/kh√°). Kh√°c nh√≥m: <i>Ng≈© Qu·ª∑/L·ª•c S√°t/Tuy·ªát M·ªánh</i> (x·∫•u).</li>
    </ul>`;
}

/* ===== Seed 2 account + 1 match + 10 user demo ===== */
(async function seedIfEmpty(){
  await IDB.open();
  const users=await IDB.getAll('users');
  if(users.length>0){ updateWhoami(await currentUser()); return; }

  // Test Nam & Test Nu
  const y1=1994, y2=1996;
  const a1=infoFromYear(y1), a2=infoFromYear(y2);
  const u1={ id:uid('u'), name:"Test Nam", gender:"Nam", year:y1, job:"Dev", finance:30, address:"HN", email:"nam@test.local", phone:null, bio:"Thich code & gym", hobbies:"code, gym", habits:"doc sach", values:"gia dinh", avatar:"", can:a1.can, chi:a1.chi, napAm:a1.napAm, element:a1.element, cungPhi:cungPhi(y1,"Nam"), createdAt: Date.now()-5000 };
  const u2={ id:uid('u'), name:"Test Nu",  gender:"N·ªØ",  year:y2, job:"Designer", finance:20, address:"HN", email:"nu@test.local",  phone:null, bio:"Yeu thien nhien", hobbies:"ve tranh", habits:"chay bo", values:"hanh phuc", avatar:"", can:a2.can, chi:a2.chi, napAm:a2.napAm, element:a2.element, cungPhi:cungPhi(y2,"N·ªØ"),  createdAt: Date.now()-4000 };

  // Extra 10 users from DATA_SEED
  const extra = DATA_SEED.map((r,i)=>{
    const y = (typeof r.year==='number' ? r.year : 1998);
    const inf = infoFromYear(y);
    return { id:uid('u'), name:r.name||('User '+(i+1)), gender:r.gender||"Kh√°c", year:y, job:r.job||"‚Äî",
      finance:r.finance||null, address:r.address||"‚Äî", email:null, phone:null, bio:r.bio||"",
      hobbies:"", habits:"", values:"", avatar:r.avatar||"",
      can:inf.can, chi:inf.chi, napAm:inf.napAm, element:inf.element, cungPhi:cungPhi(y, r.gender||"Kh√°c"),
      createdAt: Date.now()-Math.floor(Math.random()*1e6) };
  });

  await IDB.bulkPut('users',[u1,u2,...extra]);

  // T·∫°o match s·∫µn gi·ªØa Test Nam ‚Üî Test Nu
  const m={ id:uid('m'), a:u1.id, b:u2.id, at: Date.now()-3000 };
  await IDB.put('matches', m);

  // Tin nh·∫Øn m·∫´u
  await IDB.bulkPut('messages',[
    {id:uid('msg'), matchId:m.id, from:u1.id, body:"Chao ban, minh la Nam.", at: Date.now()-2500},
    {id:uid('msg'), matchId:m.id, from:u2.id, body:"Chao Nam, rat vui duoc lam quen!", at: Date.now()-2000}
  ]);

  // ƒêƒÉng nh·∫≠p s·∫µn Test Nam
  await Session.set(u1.id);
  updateWhoami(u1);
  await renderLoginSelect();
  await renderUserList();
})();

/* ===== Boot ===== */
(async function boot(){
  const me=await currentUser(); updateWhoami(me);
  await renderLoginSelect(); await renderUserList();
})();
</script>
</body>
</html>
