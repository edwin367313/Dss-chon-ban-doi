USE [DSS Mate];
GO

/* ========== 1) core ========== */
IF OBJECT_ID(N'dbo.User', N'U') IS NULL
CREATE TABLE dbo.[User](
  ID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_User PRIMARY KEY DEFAULT NEWID(),
  Email NVARCHAR(256) NOT NULL UNIQUE,
  PasswordHash NVARCHAR(256) NOT NULL,
  CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
  IsActive BIT NOT NULL DEFAULT 1
);
GO

IF OBJECT_ID(N'dbo.Profiles', N'U') IS NULL
CREATE TABLE dbo.Profiles(
  UserID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_Profiles PRIMARY KEY
    CONSTRAINT FK_Profiles_User FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  FullName NVARCHAR(128) NOT NULL,
  Gender NVARCHAR(16) NOT NULL,          -- male|female|other
  Birthday DATE NOT NULL,
  HeightCm INT NULL,
  Education NVARCHAR(32) NULL,
  Occupation NVARCHAR(64) NULL,
  Bio NVARCHAR(400) NULL,
  Zodiac NVARCHAR(16) NULL,
  MBTI NVARCHAR(8) NULL,
  CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
  Nativeland NVARCHAR(64) NULL           -- đúng như diagram ghi "Nativeland"
);
GO

IF OBJECT_ID(N'dbo.Photos', N'U') IS NULL
CREATE TABLE dbo.Photos(
  ID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_Photos PRIMARY KEY DEFAULT NEWID(),
  UserID UNIQUEIDENTIFIER NOT NULL
    CONSTRAINT FK_Photos_User FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  Url NVARCHAR(260) NOT NULL,
  IsPrimary BIT NOT NULL DEFAULT 1,
  SortOrder INT NOT NULL DEFAULT 1
);
CREATE INDEX IX_Photos_User_Sort ON dbo.Photos(UserID, SortOrder);
GO

IF OBJECT_ID(N'dbo.Citteria', N'U') IS NULL   -- tên theo đúng diagram
CREATE TABLE dbo.Citteria(
  UserID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_Citteria PRIMARY KEY
    CONSTRAINT FK_Citteria_User FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  LookingForGender NVARCHAR(16) NULL,
  AgeMin INT NULL,
  AgeMax INT NULL,
  DistanceKm INT NULL,
  EducationMin NVARCHAR(32) NULL,
  HasPhotoOnly BIT NOT NULL DEFAULT 1
);
GO

/* tags & free text */
IF OBJECT_ID(N'dbo.Tags', N'U') IS NULL
CREATE TABLE dbo.Tags(
  ID INT IDENTITY(1,1) NOT NULL CONSTRAINT PK_Tags PRIMARY KEY,
  Type NVARCHAR(16) NOT NULL,            -- hobby | thoi_quen | quan_diem
  NameOriginal NVARCHAR(128) NOT NULL,
  NameSlug NVARCHAR(128) NOT NULL UNIQUE
);
GO

IF OBJECT_ID(N'dbo.ProfileTag', N'U') IS NULL
CREATE TABLE dbo.ProfileTag(
  UserID UNIQUEIDENTIFIER NOT NULL
    CONSTRAINT FK_ProfileTag_User FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  TagID INT NOT NULL
    CONSTRAINT FK_ProfileTag_Tag FOREIGN KEY REFERENCES dbo.Tags(ID) ON DELETE CASCADE,
  CONSTRAINT PK_ProfileTag PRIMARY KEY(UserID, TagID)
);
GO

IF OBJECT_ID(N'dbo.ProfileFreeText', N'U') IS NULL
CREATE TABLE dbo.ProfileFreeText(
  UserID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_ProfileFreeText PRIMARY KEY
    CONSTRAINT FK_ProfileFreeText_User FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  HobbiesText NVARCHAR(1000) NULL,
  HabitsText NVARCHAR(1000) NULL,
  ValuesText NVARCHAR(1000) NULL
);
GO

/* ========== 2) phong thuy ========== */
IF OBJECT_ID(N'dbo.RefElement', N'U') IS NULL
CREATE TABLE dbo.RefElement(
  ID TINYINT NOT NULL CONSTRAINT PK_RefElement PRIMARY KEY,   -- 1..5
  Name NVARCHAR(8) NOT NULL UNIQUE
);
GO

IF OBJECT_ID(N'dbo.RefCan', N'U') IS NULL
CREATE TABLE dbo.RefCan(
  ID TINYINT NOT NULL CONSTRAINT PK_RefCan PRIMARY KEY,       -- 1..10
  Name NVARCHAR(8) NOT NULL UNIQUE,
  ElementID TINYINT NOT NULL
    CONSTRAINT FK_RefCan_Element FOREIGN KEY REFERENCES dbo.RefElement(ElementID)
);
GO

IF OBJECT_ID(N'dbo.RefChi', N'U') IS NULL
CREATE TABLE dbo.RefChi(
  ID TINYINT NOT NULL CONSTRAINT PK_RefChi PRIMARY KEY,       -- 1..12
  Name NVARCHAR(8) NOT NULL UNIQUE,
  TamHopGroup TINYINT NULL,
  TuXungGroup TINYINT NULL
);
GO

IF OBJECT_ID(N'dbo.RefHourChi', N'U') IS NULL
CREATE TABLE dbo.RefHourChi(
  ID TINYINT NOT NULL CONSTRAINT PK_RefHourChi PRIMARY KEY
    CONSTRAINT FK_RefHourChi_Chi FOREIGN KEY REFERENCES dbo.RefChi(ID),
  FromHour TINYINT NOT NULL,   -- 0..23
  ToHour   TINYINT NOT NULL
);
GO

IF OBJECT_ID(N'dbo.RefElementRelation', N'U') IS NULL
CREATE TABLE dbo.RefElementRelation(
  FromElementID TINYINT NOT NULL
    CONSTRAINT FK_Rel_FromEl FOREIGN KEY REFERENCES dbo.RefElement(ElementID),
  ToElementID   TINYINT NOT NULL
    CONSTRAINT FK_Rel_ToEl   FOREIGN KEY REFERENCES dbo.RefElement(ElementID),
  Relation NVARCHAR(8) NOT NULL,         -- Sinh | Khac | Same | Neutral
  CONSTRAINT PK_RefElementRelation PRIMARY KEY(FromElementID, ToElementID)
);
GO

IF OBJECT_ID(N'dbo.RefCanRelation', N'U') IS NULL
CREATE TABLE dbo.RefCanRelation(
  CanA TINYINT NOT NULL CONSTRAINT FK_CanRel_A FOREIGN KEY REFERENCES dbo.RefCan(ID),
  CanB TINYINT NOT NULL CONSTRAINT FK_CanRel_B FOREIGN KEY REFERENCES dbo.RefCan(ID),
  Type NVARCHAR(8) NOT NULL,             -- LucHop | LucXung
  CONSTRAINT PK_RefCanRelation PRIMARY KEY(CanA, CanB)
);
GO

IF OBJECT_ID(N'dbo.RefChiRelation', N'U') IS NULL
CREATE TABLE dbo.RefChiRelation(
  ChiA TINYINT NOT NULL CONSTRAINT FK_ChiRel_A FOREIGN KEY REFERENCES dbo.RefChi(ID),
  ChiB TINYINT NOT NULL CONSTRAINT FK_ChiRel_B FOREIGN KEY REFERENCES dbo.RefChi(ID),
  Type NVARCHAR(8) NOT NULL,             -- TamHop | LucHop | LucHai | TuXung
  CONSTRAINT PK_RefChiRelation PRIMARY KEY(ChiA, ChiB)
);
GO

IF OBJECT_ID(N'dbo.RefCungPhi', N'U') IS NULL
CREATE TABLE dbo.RefCungPhi(
  ID TINYINT NOT NULL CONSTRAINT PK_RefCungPhi PRIMARY KEY,   -- 1..8
  Name NVARCHAR(8) NOT NULL UNIQUE,
  Type NVARCHAR(8) NOT NULL            -- DongTu | TayTu  (đúng tên "Type" theo diagram)
);
GO

IF OBJECT_ID(N'dbo.RefBatTrach', N'U') IS NULL
CREATE TABLE dbo.RefBatTrach(
  MaleCungID   TINYINT NOT NULL CONSTRAINT FK_BatTrach_Male  FOREIGN KEY REFERENCES dbo.RefCungPhi(ID),
  FemaleID     TINYINT NOT NULL CONSTRAINT FK_BatTrach_Female FOREIGN KEY REFERENCES dbo.RefCungPhi(ID),
  Result NVARCHAR(16) NOT NULL,         -- SinhKhi | ThienY | DienNien | PhucVi | ...
  Score  SMALLINT NOT NULL,
  CONSTRAINT PK_RefBatTrach PRIMARY KEY(MaleCungID, FemaleID)
);
GO

IF OBJECT_ID(N'dbo.FengShuiProfile', N'U') IS NULL
CREATE TABLE dbo.FengShuiProfile(
  UserID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_FengShuiProfile PRIMARY KEY
    CONSTRAINT FK_FengShuiProfile_User FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  SolarDob DATE NOT NULL,
  BirthHourChiID TINYINT NULL CONSTRAINT FK_FSP_HourChi FOREIGN KEY REFERENCES dbo.RefChi(ID),
  YearCanID TINYINT NOT NULL CONSTRAINT FK_FSP_Can FOREIGN KEY REFERENCES dbo.RefCan(ID),
  YearChiID TINYINT NOT NULL CONSTRAINT FK_FSP_Chi FOREIGN KEY REFERENCES dbo.RefChi(ID),
  ElementID TINYINT NOT NULL CONSTRAINT FK_FSP_Element FOREIGN KEY REFERENCES dbo.RefElement(ElementID),
  CungPhiID TINYINT NULL CONSTRAINT FK_FSP_CungPhi FOREIGN KEY REFERENCES dbo.RefCungPhi(ID),
  GroupMenh NVARCHAR(8) NULL,
  Ready BIT NOT NULL DEFAULT 1
);
GO

/* ========== 3) interactions ========== */
IF OBJECT_ID(N'dbo.Swipes', N'U') IS NULL
CREATE TABLE dbo.Swipes(
  ID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_Swipes PRIMARY KEY DEFAULT NEWID(),
  FromUserID UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Swipes_From FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  ToUserID   UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Swipes_To   FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  Direction INT NOT NULL,             -- 1=Right, -1=Left
  CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
  CONSTRAINT UQ_Swipes UNIQUE(FromUserID, ToUserID)
);
GO

IF OBJECT_ID(N'dbo.Matches', N'U') IS NULL
CREATE TABLE dbo.Matches(
  ID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_Matches PRIMARY KEY DEFAULT NEWID(),
  UserA UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Matches_A FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  UserB UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Matches_B FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  MatchedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
  IsActive BIT NOT NULL DEFAULT 1,
  CONSTRAINT UQ_Matches UNIQUE(UserA, UserB)
);
GO

IF OBJECT_ID(N'dbo.Messages', N'U') IS NULL
CREATE TABLE dbo.Messages(
  ID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_Messages PRIMARY KEY DEFAULT NEWID(),
  MatchID UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Messages_Match FOREIGN KEY REFERENCES dbo.Matches(ID) ON DELETE CASCADE,
  FromUserID UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Messages_From FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  Body NVARCHAR(1000) NOT NULL,
  CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);
CREATE INDEX IX_Messages_Match_Created ON dbo.Messages(MatchID, CreatedAt);
GO

/* ========== 4) explain logs ========== */
IF OBJECT_ID(N'dbo.ExplainLogs', N'U') IS NULL
CREATE TABLE dbo.ExplainLogs(
  ID UNIQUEIDENTIFIER NOT NULL CONSTRAINT PK_ExplainLogs PRIMARY KEY DEFAULT NEWID(),
  UserID UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Explain_User FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  CandidateID UNIQUEIDENTIFIER NOT NULL CONSTRAINT FK_Explain_Candidate FOREIGN KEY REFERENCES dbo.[User](ID) ON DELETE CASCADE,
  Aspect NVARCHAR(32) NOT NULL,        -- NguHanh | BatTrach | Chi | Can | ...
  Detail NVARCHAR(400) NOT NULL,
  ScoreDelta INT NOT NULL,
  CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);
GO
